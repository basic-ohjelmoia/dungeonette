Toteutusdokumentti: Dungeonette
===============================
Dokumentti on "work-in-progress"
--------------------------------

Dungeonette on Javalla koodattu satunnaisluolageneraattori roolipelille, jota olen kehittänyt vapaa-ajallani. Roolipelin ympäristöt ovat kolmiulotteisia tiilikarttoja. Yksi "kartta" vastaa yhtä luonnollista sijaintia pelin maailmassa, esimerkiksi kaupunkia, linnaa tai luolastoa. Karttojen mittasuhteille - leveydelle, pituudelle ja korkeudelle (x,y,z) - ei ole periaatteessa ylärajaa, mutta mitä luultavimmin haluan pitää ne suurin piirtein suuruusluokkavälillä 100 x 100 x 10...200 x 200 x 10. 

Dungeonette on optimoitu suurin piirtein edellä mainittua suuruusluokkaa vastaavien monikerroksisten satunnaisluolien tuottamiseen. Pelisuunnittelun kannalta optimaalinen luola olisi rakenteeltaan melko selkeä, eikä sisältäisi kohtuutonta määrää umpikujamaisia rakenteita. Kunkin kerroksen sisääntulopisteen (portaikko) ja ulospääsypisteen (toinen portaikko) ei tulisi sijaita liian lähellä toisiaan, mutta portaikkojen keskinäisen etäisyyden ei silti tarvitse vastata kerroksen absoluuttista maksimietäisyyttä.

Koska koko luola tallennetaan samaan kolmiulotteiseen matriisiin, kerrosten välillä on ylläpidettävä yhdenmukaista koordinaatistoa. Kerroksen n portaikko koordinaatissa (50, 50, n) tulee jatkoa kerroksessa n+1 niin ikään koordinaatissa (50, 50, n+1). Minkään kerroksen mikään huone ei voi sijaita kaikille kerroksille määriteltyjen yhteisten ulkorajojen ulkopuolella. 

Dungeonetten luolagenerointi perustuu huoneisiin. Huoneet generoidaan karkeaan koordinaatistoon, joka vastaa pääkoordinaatistossa 10 x 10 tiilen kokoista aluetta. Huone voi karkean koordinaattinsa sisällä olla periaatteessa minkä muotoinen tahansa. Huone voi toisaalta levittäytyä useamman kuin yhden karkean koordinaatin alueelle, suurimmillaan 3 x 3 karkeaa koordinaattia eli 30 x 30 tiiltä vastaavalle alueelle. Oli huone minkä suuruinen tahansa, kukin karkea koordinaatti voi kuulua vain yhdelle huoneelle kerrallaan. Samaan kerrokseen ei siis voi generoida toisiaan leikkaavia huoneita. 
Erilliset huoneet voivat silti siinä mielessä sulautua yhteen, että huoneiden generointia seuraava käytävien kaivertamisvaihe saattaa hävittää huoneesta ulkoseiniä. Mitä useampi käytävä generoidaan, sitä suurempi deformaatio huoneisiin voi kohdistua. Käytävien kaivertaminen on kuitenkin algoritmisella tasolla tiukasti säänneltyä, joten ellei algoritmia eksplisiittisesti parametrisoida tuottamaan poikkeuksellisen paljon käytäviä, huoneiden pitäisi erottua luolakerroksen pohjapiirustuksesta (konsolitulosteesta) selkeästi.

Dungeonette säilöö generoitavan luolan perusparametrit Specification-nimiseen luokkaan ja itse luolaston Environment-olioksi, jonka jokainen kerros muodostaa Floor-olion ja kerroksen jokainen huone Room-olion. Varsinainen luolagenerointi tapahtuu Generator-pakkauksen staattisissa luokissa, joista Architect ajaa varsinaista luolageneraation pääsilmukkaa. 

Luolan generointi tapahtuu pääpiirteissään siten, että Architect valitsee yhden huoneen aktiiviseksi ja yrittää löytää sen vierestä sopivaa tyhjää tilaa naapurihuoneelle. Jos ja kun tällainen tila löytyy (validointi tapahtuu RoomInserter-luokassa), uusi huone generoidaan ja se ja aktiivisena ollut huone merkitään toisiinsa kytkettäviksi.

Architect-luokan pääsilmukan keskeisin tietorakenne on RoomQueue-pseudojono, johon kukin onnistuneesti generoitu (laillisen paikan karkeasta koordinaatistosta löytänyt) huone lisätään. RoomQueue eroaa aidosta jonosta siinä, että dequeue-kutsu ei automaattisesti poista huonetta jonosta, vaan ainoastaan vähentää huoneelle myönnettyjä jatkoyhteyksiä yhdellä yksiköllä. Jatkoyhteydellä tarkoitetaan käytävää seuraavaan, vielä generoimattomaan huoneeseen. Vasta kun dequeue toteaa huoneen jatkoyhteysarvon nollaksi, kutsu poistaa huoneen jonosta. Jonosta poistettua huonetta ei enää tämän jälkeen käsitellä Architechin pääsilmukassa.

Kun Architect havaitsee RoomQueuensa tyhjäksi luolakerros katsotaan valmiiksi. Kerros voi siis valmistua ennen kuin sen nimellinen maksimihuonemäärä (esim. 50 kpl) on saavutettu. Huoneiden generoinnin jälkeen generoidaan vielä käytävät huoneiden välille. Vaikka algoritmi tukee myös mielivaltaisten käytävien generointia, suurin osa generoitavista käytävistä perustuu huoneiden välille merkittyihin eksplisiittisiin yhteyksiin. Algoritmi pyrkii välttämään tarpeetonta huoneiden yhdistelyä: algoritmin näkökulmasta riittää, että huoneella on edes yksi laillinen yhteys luolaston aloituspisteeseen (portaikkoon).

Dungeonetten aika- ja tilavaativuuden pitäisi olla O(n) eli täysin linjassa Specification-luokalle annettujen syötteiden suuruusluokkaan. Teoreettisen suurilla syötteillä aikavaativuudessa aikavaativuus saattaa painua jopa selvästi O(n):n alle, riippuen siitä sisällytetäänkö generoitavien huoneiden lukumäärä osaksi syötettä vai ei. Huoneluku ei nimittäin skaalaudu ylöspäin syötteen mukana.

